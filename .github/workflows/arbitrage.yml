name: Run Arbitrage Script with OpenVPN

on:
  schedule:
    - cron: "*/45 * * * *"  
  workflow_dispatch:        

jobs:
  run-arbitrage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install OpenVPN
        run: sudo apt-get update && sudo apt-get install -y openvpn

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Save OpenVPN config file
        run: echo "${{ secrets.OPENVPN_CONFIG }}" > vpnconfig.ovpn

      # If your VPN uses username/password, create the auth file:
      - name: Create VPN auth file
        if: ${{ secrets.OPENVPN_USERNAME && secrets.OPENVPN_PASSWORD }}
        run: |
          echo "${{ secrets.OPENVPN_USERNAME }}" > vpn-auth.txt
          echo "${{ secrets.OPENVPN_PASSWORD }}" >> vpn-auth.txt

      # Modify your vpnconfig.ovpn to include:
      # auth-user-pass vpn-auth.txt
      # (Do this only if your config requires user/pass)
      - name: Modify VPN config for auth-user-pass
        if: ${{ secrets.OPENVPN_USERNAME && secrets.OPENVPN_PASSWORD }}
        run: |
          echo "auth-user-pass vpn-auth.txt" >> vpnconfig.ovpn

      - name: Connect to VPN
        run: sudo openvpn --config vpnconfig.ovpn --daemon

      - name: Wait for VPN connection
        run: sleep 15

      - name: Verify VPN connection IP
        run: curl https://ifconfig.me

      - name: Run arbitrage script
        env:
          EXCHANGE_RATE_API_KEY: ${{ secrets.EXCHANGE_RATE_API_KEY }}
          COINSWITCH_API_KEY: ${{ secrets.COINSWITCH_API_KEY }}
          COINSWITCH_API_SECRET: ${{ secrets.COINSWITCH_API_SECRET }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: python arbitrage_runner.py

      - name: Disconnect VPN
        run: sudo pkill openvpn
